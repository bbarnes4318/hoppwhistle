name: SIP Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  sip-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 25  # Increased timeout to handle slow steps

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Cache Docker layers for faster pulls
      - name: Pull and start services
        run: |
          docker compose -f infra/docker/docker-compose.ci.yml pull --quiet
          docker compose -f infra/docker/docker-compose.ci.yml up -d
          docker compose -f infra/docker/docker-compose.ci.yml ps

      - name: Wait for services to be healthy
        timeout-minutes: 3
        run: |
          echo "Waiting for services..."
          sleep 15
          docker compose -f infra/docker/docker-compose.ci.yml ps

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      # Cache pnpm store for faster installs
      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Run SIP tests
        timeout-minutes: 10
        run: pnpm test:sip:ci
        env:
          KAMAILIO_HOST: localhost
          KAMAILIO_PORT: 5061
          FREESWITCH_HOST: localhost
          FREESWITCH_PORT: 5060

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker Compose Logs ==="
          docker compose -f infra/docker/docker-compose.ci.yml logs --tail=50

      - name: Cleanup
        if: always()
        timeout-minutes: 1
        run: |
          docker compose -f infra/docker/docker-compose.ci.yml kill || true
          docker compose -f infra/docker/docker-compose.ci.yml down -v --remove-orphans || true
