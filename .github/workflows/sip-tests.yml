name: SIP Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  sip-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Use CI-specific compose with pre-built images - NO BUILD REQUIRED
      - name: Pull and start services
        run: |
          docker compose -f infra/docker/docker-compose.ci.yml pull
          docker compose -f infra/docker/docker-compose.ci.yml up -d
          docker compose -f infra/docker/docker-compose.ci.yml ps

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services..."
          for i in {1..30}; do
            if docker compose -f infra/docker/docker-compose.ci.yml ps | grep -q "unhealthy\|starting"; then
              echo "Services still starting... ($i/30)"
              sleep 2
            else
              echo "All services healthy!"
              break
            fi
          done
          docker compose -f infra/docker/docker-compose.ci.yml ps

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run SIP tests
        run: pnpm test:sip:ci
        env:
          KAMAILIO_HOST: localhost
          KAMAILIO_PORT: 5061
          FREESWITCH_HOST: localhost
          FREESWITCH_PORT: 5060

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker Compose Logs ==="
          docker compose -f infra/docker/docker-compose.ci.yml logs --tail=50

      - name: Cleanup
        if: always()
        timeout-minutes: 1
        run: |
          docker compose -f infra/docker/docker-compose.ci.yml down -v -t 3 || true
